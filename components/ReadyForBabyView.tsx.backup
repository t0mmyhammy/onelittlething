'use client';

import { useState } from 'react';
import { createClient } from '@/lib/supabase/client';
import {
  PlusIcon,
  ChevronDownIcon,
  ChevronUpIcon,
  EyeSlashIcon,
  EyeIcon,
  SparklesIcon,
  ChatBubbleLeftIcon,
  HeartIcon,
  InformationCircleIcon,
  RocketLaunchIcon,
} from '@heroicons/react/24/outline';
import { HeartIcon as HeartSolidIcon } from '@heroicons/react/24/solid';
import RecommendedTasksModal from './RecommendedTasksModal';
import { getRecommendedTasksForFamily, RecommendedTask } from '@/lib/baby-prep-templates';
import Link from 'next/link';
import NamesSummaryCard from './NamesSummaryCard';

interface BabyPrepList {
  id: string;
  family_id: string;
  due_date: string | null;
  stage: 'first' | 'second' | 'third' | 'fourth' | null;
  is_second_child: boolean;
  baby_named: boolean;
  hide_names: boolean;
  created_at: string;
  updated_at: string;
}

interface BabyPrepTask {
  id: string;
  list_id: string;
  category: 'essentials' | 'family_home' | 'money_admin' | 'emotional_community' | 'name_ideas';
  title: string;
  description: string | null;
  is_complete: boolean;
  completed_by: string | null;
  completed_at: string | null;
  order_index: number;
  created_at: string;
  updated_at: string;
}

interface BabyNameIdea {
  id: string;
  family_id: string;
  name: string;
  type: 'F' | 'M' | 'N';
  notes: string | null;
  ai_enhanced_notes: any;
  reactions: any;
  is_favorite: boolean;
  created_by: string | null;
  created_at: string;
  updated_at: string;
}

interface BabyNameComment {
  id: string;
  name_id: string;
  user_id: string | null;
  comment_text: string;
  created_at: string;
}

interface ReadyForBabyViewProps {
  babyPrepList: BabyPrepList | null;
  tasks: BabyPrepTask[];
  firstNameCount: number;
  middleNameCount: number;
  dueDate: string | null;
  userId: string;
  familyId: string;
}

const CATEGORY_CONFIG = {
  essentials: {
    title: 'The Essentials',
    icon: 'üë∂',
    color: 'amber',
    defaultTasks: [
      { title: 'Choose a pediatrician', description: 'Research and schedule meet-and-greet appointments' },
      { title: 'Confirm hospital registration', description: 'Complete pre-registration paperwork' },
      { title: 'Pack hospital bags', description: 'Prepare bags for mom, dad, and baby' },
      { title: 'Finalize car seat installation', description: 'Get it inspected by a certified technician' },
      { title: 'Stock up on newborn basics', description: 'Diapers, wipes, onesies, and feeding supplies' },
    ],
  },
  family_home: {
    title: 'Family & Home',
    icon: 'üè†',
    color: 'sage',
    defaultTasks: [
      { title: 'Create a sleep or feeding zone at home', description: 'Set up a dedicated space for baby care' },
      { title: 'Wash and store bottles, burp cloths, and onesies', description: 'Prepare baby items for use' },
      { title: 'Deep clean key areas', description: 'Kitchen, nursery, and car' },
      { title: 'Prepare older kids\' routines', description: 'Discuss changes and maintain stability' },
      { title: 'Plan sibling transition gifts', description: 'Help older siblings feel included' },
    ],
  },
  money_admin: {
    title: 'Money & Admin',
    icon: 'üí∏',
    color: 'blue',
    defaultTasks: [
      { title: 'Update or open 529 plan', description: 'Start saving for college' },
      { title: 'Review parental leave plans', description: 'Confirm benefits and timing' },
      { title: 'Adjust childcare coverage for sibling', description: 'Plan for older kids during hospital stay' },
      { title: 'Review life insurance coverage', description: 'Ensure adequate protection' },
      { title: 'Update wills and guardianship', description: 'Keep legal documents current' },
      { title: 'Freeze new baby\'s credit', description: 'Protect against identity theft' },
    ],
  },
  emotional_community: {
    title: 'Emotional & Community Prep',
    icon: 'üíõ',
    color: 'rose',
    defaultTasks: [
      { title: 'Create a short "welcome letter" to your baby', description: 'Capture your feelings before arrival' },
      { title: 'Discuss boundaries for visitors', description: 'Plan when and how visitors can meet baby' },
      { title: 'Organize a meal train', description: 'Coordinate support from friends and family' },
      { title: 'Schedule downtime or self-care days', description: 'Plan rest before baby arrives' },
      { title: 'Add ideas for meaningful photos or rituals', description: 'Capture special moments' },
    ],
  },
};

export default function ReadyForBabyView({
  babyPrepList: initialBabyPrepList,
  tasks: initialTasks,
  firstNameCount,
  middleNameCount,
  dueDate,
  userId,
  familyId,
}: ReadyForBabyViewProps) {
  const [babyPrepList, setBabyPrepList] = useState(initialBabyPrepList);
  const [tasks, setTasks] = useState(initialTasks);
  const [expandedSections, setExpandedSections] = useState<Set<string>>(
    new Set(['essentials', 'family_home', 'money_admin', 'emotional_community', 'name_ideas'])
  );
  const [hideCompleted, setHideCompleted] = useState(false);
  const [newTaskInputs, setNewTaskInputs] = useState<Record<string, string>>({});
  const [newNameInput, setNewNameInput] = useState({ name: '', type: 'N' as 'F' | 'M' | 'N', notes: '' });
  const [showNameTooltip, setShowNameTooltip] = useState(false);
  const [showRecommendationsModal, setShowRecommendationsModal] = useState(false);
  const [recommendationsCategory, setRecommendationsCategory] = useState<string | null>(null);
  const [generatingHospitalBags, setGeneratingHospitalBags] = useState(false);
  const [generatedPackListIds, setGeneratedPackListIds] = useState<string[]>([]);
  const [showOnlyFavorites, setShowOnlyFavorites] = useState(false);
  const [editingNameId, setEditingNameId] = useState<string | null>(null);
  const [editingNameValue, setEditingNameValue] = useState('');
  const [editingNameNotes, setEditingNameNotes] = useState('');
  const [familyLastName, setFamilyLastName] = useState('');
  const supabase = createClient();

  // Determine if family has older children (to show context-specific tasks)
  const hasOlderChildren = babyPrepList?.is_second_child || false;

  const toggleSection = (category: string) => {
    const newExpanded = new Set(expandedSections);
    if (newExpanded.has(category)) {
      newExpanded.delete(category);
    } else {
      newExpanded.add(category);
    }
    setExpandedSections(newExpanded);
  };

  const getTasksByCategory = (category: string) => {
    return tasks.filter(t => t.category === category);
  };

  const getCompletedCount = (category: string) => {
    return tasks.filter(t => t.category === category && t.is_complete).length;
  };

  const getVisibleTasks = (category: string) => {
    const categoryTasks = getTasksByCategory(category);
    return hideCompleted ? categoryTasks.filter(t => !t.is_complete) : categoryTasks;
  };

  const handleToggleTask = async (taskId: string) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const { error } = await supabase
      .from('baby_prep_tasks')
      .update({
        is_complete: !task.is_complete,
        completed_by: !task.is_complete ? userId : null,
        completed_at: !task.is_complete ? new Date().toISOString() : null,
      })
      .eq('id', taskId);

    if (!error) {
      setTasks(tasks.map(t =>
        t.id === taskId
          ? { ...t, is_complete: !t.is_complete, completed_by: !t.is_complete ? userId : null, completed_at: !t.is_complete ? new Date().toISOString() : null }
          : t
      ));
    }
  };

  const handleAddTask = async (category: string) => {
    const title = newTaskInputs[category];
    if (!title?.trim() || !babyPrepList) return;

    const maxOrder = Math.max(...getTasksByCategory(category).map(t => t.order_index), -1);

    const { data, error } = await supabase
      .from('baby_prep_tasks')
      .insert({
        list_id: babyPrepList.id,
        category,
        title: title.trim(),
        order_index: maxOrder + 1,
      })
      .select()
      .single();

    if (!error && data) {
      setTasks([...tasks, data]);
      setNewTaskInputs({ ...newTaskInputs, [category]: '' });
    }
  };

  const handleDeleteTask = async (taskId: string) => {
    const { error } = await supabase
      .from('baby_prep_tasks')
      .delete()
      .eq('id', taskId);

    if (!error) {
      setTasks(tasks.filter(t => t.id !== taskId));
    }
  };

  const handleAddNameIdea = async () => {
    if (!newNameInput.name.trim()) return;

    const { data, error } = await supabase
      .from('baby_name_ideas')
      .insert({
        family_id: familyId,
        name: newNameInput.name.trim(),
        type: newNameInput.type,
        notes: newNameInput.notes.trim() || null,
        created_by: userId,
      })
      .select()
      .single();

    if (!error && data) {
      setNameIdeas([data, ...nameIdeas]);
      setNewNameInput({ name: '', type: 'N', notes: '' });
    }
  };

  const handleToggleReaction = async (nameId: string, emoji: string) => {
    const nameIdea = nameIdeas.find(n => n.id === nameId);
    if (!nameIdea) return;

    const reactions = nameIdea.reactions || {};
    const userReactions = reactions[userId] || [];
    const hasReaction = userReactions.includes(emoji);

    const newUserReactions = hasReaction
      ? userReactions.filter((e: string) => e !== emoji)
      : [...userReactions, emoji];

    const newReactions = { ...reactions, [userId]: newUserReactions };

    const { error } = await supabase
      .from('baby_name_ideas')
      .update({ reactions: newReactions })
      .eq('id', nameId);

    if (!error) {
      setNameIdeas(nameIdeas.map(n =>
        n.id === nameId ? { ...n, reactions: newReactions } : n
      ));
    }
  };

  const handleEnhanceName = async (nameId: string) => {
    const nameIdea = nameIdeas.find(n => n.id === nameId);
    if (!nameIdea) return;

    // Get sibling names (children already born)
    const siblingNames = children
      .filter(c => new Date(c.birthdate) <= new Date())
      .map(c => c.name);

    // Call AI endpoint to enhance name
    try {
      const response = await fetch('/api/enhance-baby-name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: nameIdea.name,
          type: nameIdea.type,
          siblingNames,
          lastName: familyLastName || undefined,
        }),
      });

      if (response.ok) {
        const data = await response.json();

        const { error } = await supabase
          .from('baby_name_ideas')
          .update({ ai_enhanced_notes: data.enhancements })
          .eq('id', nameId);

        if (!error) {
          setNameIdeas(nameIdeas.map(n =>
            n.id === nameId ? { ...n, ai_enhanced_notes: data.enhancements } : n
          ));
        }
      }
    } catch (error) {
      console.error('Failed to enhance name:', error);
    }
  };

  const handleDeleteNameIdea = async (nameId: string) => {
    const { error } = await supabase
      .from('baby_name_ideas')
      .delete()
      .eq('id', nameId);

    if (!error) {
      setNameIdeas(nameIdeas.filter(n => n.id !== nameId));
    }
  };

  const initializeDefaultTasks = async (category: keyof typeof CATEGORY_CONFIG) => {
    if (!babyPrepList) return;

    const config = CATEGORY_CONFIG[category];
    const existingTasks = getTasksByCategory(category);

    if (existingTasks.length > 0) return;

    const tasksToInsert = config.defaultTasks.map((task, index) => ({
      list_id: babyPrepList.id,
      category,
      title: task.title,
      description: task.description,
      order_index: index,
    }));

    const { data, error } = await supabase
      .from('baby_prep_tasks')
      .insert(tasksToInsert)
      .select();

    if (!error && data) {
      setTasks([...tasks, ...data]);
    }
  };

  const handleShowRecommendations = (category: string) => {
    if (!babyPrepList) {
      console.error('Cannot show recommendations: babyPrepList is null');
      alert('Unable to load recommendations. Please refresh the page.');
      return;
    }
    setRecommendationsCategory(category);
    setShowRecommendationsModal(true);
  };

  const handleAddRecommendedTasks = async (recommendedTasks: RecommendedTask[]) => {
    console.log('handleAddRecommendedTasks called');
    console.log('babyPrepList:', babyPrepList);
    console.log('recommendationsCategory:', recommendationsCategory);

    if (!babyPrepList || !recommendationsCategory) {
      console.error('Missing babyPrepList or recommendationsCategory');
      console.error('babyPrepList is null:', !babyPrepList);
      console.error('recommendationsCategory is null:', !recommendationsCategory);
      alert(`Cannot add tasks: ${!babyPrepList ? 'Baby prep list not found' : 'Category not set'}`);
      return;
    }

    console.log('Adding recommended tasks:', recommendedTasks);
    console.log('Category:', recommendationsCategory);

    const existingTasks = getTasksByCategory(recommendationsCategory);
    const maxOrder = Math.max(...existingTasks.map(t => t.order_index), -1);

    const tasksToInsert = recommendedTasks.map((task, index) => ({
      list_id: babyPrepList.id,
      category: recommendationsCategory,
      title: task.title,
      description: task.description || null,
      order_index: maxOrder + 1 + index,
    }));

    console.log('Tasks to insert:', tasksToInsert);

    const { data, error } = await supabase
      .from('baby_prep_tasks')
      .insert(tasksToInsert)
      .select();

    if (error) {
      console.error('Error inserting tasks:', error);
      alert('Failed to add tasks. Please try again.');
      return;
    }

    if (data) {
      console.log('Successfully inserted tasks:', data);
      setTasks([...tasks, ...data]);
    }
  };

  const handleGenerateHospitalBags = async () => {
    if (!babyPrepList) return;

    setGeneratingHospitalBags(true);

    try {
      const response = await fetch('/api/generate-hospital-bags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          familyId,
          hasOlderChildren,
          templateId: 'hospital-bags',
        }),
      });

      if (response.ok) {
        const data = await response.json();
        setGeneratedPackListIds(data.packListIds || []);
      } else {
        console.error('Failed to generate hospital bags');
      }
    } catch (error) {
      console.error('Error generating hospital bags:', error);
    } finally {
      setGeneratingHospitalBags(false);
    }
  };

  const handleToggleBabyNamed = async () => {
    if (!babyPrepList) return;

    const newValue = !babyPrepList.baby_named;

    const { error } = await supabase
      .from('baby_prep_lists')
      .update({ baby_named: newValue })
      .eq('id', babyPrepList.id);

    if (!error) {
      setBabyPrepList({ ...babyPrepList, baby_named: newValue });
    }
  };

  const handleToggleHideNames = async () => {
    if (!babyPrepList) return;

    const newValue = !babyPrepList.hide_names;

    const { error } = await supabase
      .from('baby_prep_lists')
      .update({ hide_names: newValue })
      .eq('id', babyPrepList.id);

    if (!error) {
      setBabyPrepList({ ...babyPrepList, hide_names: newValue });
    }
  };

  const handleToggleFavorite = async (nameId: string) => {
    const nameIdea = nameIdeas.find(n => n.id === nameId);
    if (!nameIdea) return;

    const newValue = !nameIdea.is_favorite;

    const { error } = await supabase
      .from('baby_name_ideas')
      .update({ is_favorite: newValue })
      .eq('id', nameId);

    if (!error) {
      setNameIdeas(nameIdeas.map(n =>
        n.id === nameId ? { ...n, is_favorite: newValue } : n
      ));
    }
  };

  const handleUpdateName = async (nameId: string) => {
    if (!editingNameValue.trim()) return;

    const { error } = await supabase
      .from('baby_name_ideas')
      .update({
        name: editingNameValue.trim(),
        notes: editingNameNotes.trim() || null,
      })
      .eq('id', nameId);

    if (!error) {
      setNameIdeas(nameIdeas.map(n =>
        n.id === nameId
          ? { ...n, name: editingNameValue.trim(), notes: editingNameNotes.trim() || null }
          : n
      ));
      setEditingNameId(null);
      setEditingNameValue('');
      setEditingNameNotes('');
    }
  };

  return (
    <>
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-serif text-gray-900 mb-2">Ready for Baby</h1>
        <p className="text-gray-600">
          A calm, supportive guide to help you prepare ‚Äî practically and emotionally ‚Äî for your baby's arrival.
        </p>
      </div>

      {/* Error State - Baby Prep List Not Found */}
      {!babyPrepList && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p className="text-red-800 font-medium mb-2">Unable to load your baby prep list</p>
          <p className="text-red-700 text-sm mb-3">
            There was an error creating or loading your preparation checklist. This could be due to a database permission issue.
          </p>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium"
          >
            Retry
          </button>
        </div>
      )}

      {/* Only show content if babyPrepList exists */}
      {babyPrepList && (
        <>
          {/* Name Ideas & Meaning Section - Moved to Top */}
          <div className="bg-white rounded-xl border border-gray-200 mb-6">
            <div className="flex items-center justify-between p-4">
              <button
                onClick={() => toggleSection('name_ideas')}
                className="flex-1 flex items-center gap-3 hover:opacity-80 transition-opacity"
              >
                <span className="text-2xl">‚ú®</span>
                <div className="text-left">
                  <h3 className="text-lg font-semibold text-gray-900">Name Ideas & Meaning</h3>
                  <p className="text-sm text-gray-500">
                    {babyPrepList.baby_named
                      ? "You've chosen a name!"
                      : `${nameIdeas.length} idea${nameIdeas.length !== 1 ? 's' : ''}`
                    }
                  </p>
                </div>
              </button>
              <div className="flex items-center gap-2">
                {expandedSections.has('name_ideas') ? (
                  <ChevronUpIcon className="w-5 h-5 text-gray-400" />
                ) : (
                  <ChevronDownIcon className="w-5 h-5 text-gray-400" />
                )}
              </div>
            </div>

            {expandedSections.has('name_ideas') && (
              <div className="border-t border-gray-200 p-4">
                {/* Privacy & Status Controls */}
                <div className="mb-4 space-y-3">
                  <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div className="flex-1">
                      <label className="font-medium text-gray-900 block mb-1">
                        Baby has been named
                      </label>
                      <p className="text-xs text-gray-600">
                        Check this if you've officially chosen a name
                      </p>
                    </div>
                    <button
                      onClick={handleToggleBabyNamed}
                      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                        babyPrepList.baby_named ? 'bg-sage' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                          babyPrepList.baby_named ? 'translate-x-6' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>

                  <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div className="flex-1">
                      <label className="font-medium text-gray-900 block mb-1">
                        Keep names private
                      </label>
                      <p className="text-xs text-gray-600">
                        Hide name ideas from others who can see this page
                      </p>
                    </div>
                    <button
                      onClick={handleToggleHideNames}
                      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                        babyPrepList.hide_names ? 'bg-sage' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                          babyPrepList.hide_names ? 'translate-x-6' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>
                </div>

                {/* Privacy Message */}
                {babyPrepList.hide_names ? (
                  <div className="p-6 bg-sage/5 border border-sage/20 rounded-lg text-center">
                    <EyeSlashIcon className="w-12 h-12 text-sage mx-auto mb-3 opacity-50" />
                    <p className="text-sage font-medium mb-1">Names are private</p>
                    <p className="text-sm text-gray-600">
                      Your name ideas are hidden from others. Toggle "Keep names private" above to share them.
                    </p>
                  </div>
                ) : babyPrepList.baby_named ? (
                  <div className="p-6 bg-amber-50 border border-amber-200 rounded-lg text-center">
                    <span className="text-4xl mb-3 block">üéâ</span>
                    <p className="text-amber-900 font-medium mb-1">Congratulations on choosing a name!</p>
                    <p className="text-sm text-amber-800">
                      Your baby's name has been chosen. You can still browse ideas below if you'd like.
                    </p>
                  </div>
                ) : (
                  <>
                    {/* Tooltip */}
                    <div className="mb-4 p-3 bg-blue-50 rounded-lg flex items-start gap-2">
                      <InformationCircleIcon className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                      <p className="text-sm text-blue-900">
                        Parents often choose names based on family history, cultural origins, sound, or meaning. Try mixing inspiration from each!
                      </p>
                    </div>

                    {/* Name Tools & Last Name Input */}
                    <div className="mb-4 space-y-3">
                      <div className="flex flex-wrap gap-2">
                        <button
                          onClick={() => setShowOnlyFavorites(!showOnlyFavorites)}
                          className={`flex items-center gap-2 px-3 py-2 text-sm rounded-lg transition-colors ${
                            showOnlyFavorites
                              ? 'bg-amber-100 text-amber-900 border border-amber-300'
                              : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'
                          }`}
                        >
                          <span className="text-base">‚≠ê</span>
                          {showOnlyFavorites ? 'Show all names' : 'Show favorites only'}
                        </button>
                      </div>

                      {/* Family Last Name */}
                      <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <label className="text-xs font-semibold text-blue-900 uppercase tracking-wide block mb-2">
                          Family Last Name (Optional)
                        </label>
                        <p className="text-xs text-blue-800 mb-2">
                          Add your last name to see how each first name flows with it, check initials, and get better compatibility insights.
                        </p>
                        <input
                          type="text"
                          value={familyLastName}
                          onChange={(e) => setFamilyLastName(e.target.value)}
                          placeholder="Enter last name"
                          className="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>

                    {/* Name Ideas Table */}
                    <div className="space-y-3 mb-4">
                      {nameIdeas
                        .filter(nameIdea => !showOnlyFavorites || nameIdea.is_favorite)
                        .map((nameIdea) => {
                        const userReactions = nameIdea.reactions?.[userId] || [];
                        const enhanced = nameIdea.ai_enhanced_notes;

                        return (
                          <div key={nameIdea.id} className={`border rounded-lg p-3 ${
                            nameIdea.is_favorite ? 'border-amber-300 bg-amber-50/30' : 'border-gray-200'
                          }`}>
                            {editingNameId === nameIdea.id ? (
                              /* Edit Mode */
                              <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                  <input
                                    type="text"
                                    value={editingNameValue}
                                    onChange={(e) => setEditingNameValue(e.target.value)}
                                    className="flex-1 px-3 py-2 text-sm border border-sage rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                                    placeholder="Name"
                                  />
                                  <span className={`text-xs px-2 py-1 rounded-full ${
                                    nameIdea.type === 'F' ? 'bg-pink-100 text-pink-700' :
                                    nameIdea.type === 'M' ? 'bg-blue-100 text-blue-700' :
                                    'bg-gray-100 text-gray-700'
                                  }`}>
                                    {nameIdea.type === 'F' ? 'Girl' : nameIdea.type === 'M' ? 'Boy' : 'Neutral'}
                                  </span>
                                </div>
                                <textarea
                                  value={editingNameNotes}
                                  onChange={(e) => setEditingNameNotes(e.target.value)}
                                  className="w-full px-3 py-2 text-sm border border-sage rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                                  placeholder="Notes (optional)"
                                  rows={2}
                                />
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => handleUpdateName(nameIdea.id)}
                                    className="px-3 py-1.5 bg-sage text-white rounded-lg hover:opacity-90 text-sm font-medium"
                                  >
                                    Save
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingNameId(null);
                                      setEditingNameValue('');
                                      setEditingNameNotes('');
                                    }}
                                    className="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium"
                                  >
                                    Cancel
                                  </button>
                                </div>
                              </div>
                            ) : (
                              /* View Mode */
                              <>
                                <div className="flex items-start justify-between mb-2">
                                  <div className="flex items-center gap-2">
                                    <button
                                      onClick={() => handleToggleFavorite(nameIdea.id)}
                                      className="text-xl hover:scale-110 transition-transform"
                                      title={nameIdea.is_favorite ? 'Remove from favorites' : 'Add to favorites'}
                                    >
                                      {nameIdea.is_favorite ? '‚≠ê' : '‚òÜ'}
                                    </button>
                                    <span className="font-semibold text-gray-900">{nameIdea.name}</span>
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                                      nameIdea.type === 'F' ? 'bg-pink-100 text-pink-700' :
                                      nameIdea.type === 'M' ? 'bg-blue-100 text-blue-700' :
                                      'bg-gray-100 text-gray-700'
                                    }`}>
                                      {nameIdea.type === 'F' ? 'Girl' : nameIdea.type === 'M' ? 'Boy' : 'Neutral'}
                                    </span>
                                  </div>
                                  <div className="flex gap-1">
                                    <button
                                      onClick={() => {
                                        setEditingNameId(nameIdea.id);
                                        setEditingNameValue(nameIdea.name);
                                        setEditingNameNotes(nameIdea.notes || '');
                                      }}
                                      className="text-xs text-gray-600 hover:text-sage px-2 py-1"
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => handleDeleteNameIdea(nameIdea.id)}
                                      className="text-xs text-red-600 hover:text-red-700 px-2 py-1"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </div>

                                {nameIdea.notes && (
                                  <p className="text-sm text-gray-600 mb-2">{nameIdea.notes}</p>
                                )}

                            {enhanced && (
                              <div className="text-sm space-y-2 mb-3 p-3 bg-sage/5 rounded-lg border border-sage/20">
                                {enhanced.meaning && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">Meaning</p>
                                    <p className="text-gray-700">{enhanced.meaning}</p>
                                  </div>
                                )}
                                {enhanced.origin && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">Origin</p>
                                    <p className="text-gray-700">{enhanced.origin}</p>
                                  </div>
                                )}
                                {enhanced.popularity && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">Popularity</p>
                                    <p className="text-gray-700">{enhanced.popularity}</p>
                                  </div>
                                )}
                                {enhanced.nicknames && enhanced.nicknames.length > 0 && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-1">Nicknames</p>
                                    <div className="flex flex-wrap gap-1.5">
                                      {enhanced.nicknames.map((nick: string, i: number) => (
                                        <span key={i} className="text-xs px-2 py-1 bg-white border border-sage/30 text-gray-700 rounded-full">
                                          {nick}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                                {enhanced.siblingCompatibility && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">With Siblings</p>
                                    <p className="text-gray-700">{enhanced.siblingCompatibility}</p>
                                  </div>
                                )}
                                {enhanced.fullNameFlow && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">Full Name</p>
                                    <p className="text-gray-700">{enhanced.fullNameFlow}</p>
                                  </div>
                                )}
                                {enhanced.initials && (
                                  <div>
                                    <p className="text-xs font-semibold text-sage uppercase tracking-wide mb-0.5">Initials</p>
                                    <p className="text-gray-700">{enhanced.initials}</p>
                                  </div>
                                )}
                              </div>
                            )}

                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => handleToggleReaction(nameIdea.id, '‚ù§Ô∏è')}
                                className="flex items-center gap-1 text-xs px-2 py-1 rounded-full hover:bg-gray-100 transition-colors"
                              >
                                {userReactions.includes('‚ù§Ô∏è') ? (
                                  <HeartSolidIcon className="w-4 h-4 text-red-500" />
                                ) : (
                                  <HeartIcon className="w-4 h-4 text-gray-400" />
                                )}
                              </button>
                              <button
                                onClick={() => handleToggleReaction(nameIdea.id, 'üí¨')}
                                className="flex items-center gap-1 text-xs px-2 py-1 rounded-full hover:bg-gray-100 transition-colors"
                              >
                                <ChatBubbleLeftIcon className="w-4 h-4 text-gray-400" />
                              </button>
                              {!enhanced && (
                                <button
                                  onClick={() => handleEnhanceName(nameIdea.id)}
                                  className="flex items-center gap-1 text-xs px-2 py-1 rounded-full hover:bg-gray-100 transition-colors ml-auto"
                                >
                                  <SparklesIcon className="w-4 h-4 text-sage" />
                                  <span className="text-sage">Enhance</span>
                                </button>
                              )}
                            </div>
                              </>
                            )}
                          </div>
                        );
                      })}
                    </div>

                    {/* Add New Name */}
                    <div className="pt-4 border-t border-gray-200">
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                        <input
                          type="text"
                          value={newNameInput.name}
                          onChange={(e) => setNewNameInput({ ...newNameInput, name: e.target.value })}
                          placeholder="Name"
                          className="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                        />
                        <select
                          value={newNameInput.type}
                          onChange={(e) => setNewNameInput({ ...newNameInput, type: e.target.value as 'F' | 'M' | 'N' })}
                          className="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                        >
                          <option value="N">Neutral</option>
                          <option value="F">Girl</option>
                          <option value="M">Boy</option>
                        </select>
                        <button
                          onClick={handleAddNameIdea}
                          className="px-4 py-2 bg-sage text-white rounded-lg hover:opacity-90 text-sm font-medium flex items-center justify-center gap-2"
                        >
                          <PlusIcon className="w-4 h-4" />
                          Add
                        </button>
                      </div>
                      <input
                        type="text"
                        value={newNameInput.notes}
                        onChange={(e) => setNewNameInput({ ...newNameInput, notes: e.target.value })}
                        placeholder="Notes (optional)"
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                      />
                    </div>
                  </>
                )}
              </div>
            )}
          </div>

          {/* Global Controls */}
          <div className="flex items-center justify-between mb-6">
            <button
              onClick={() => setHideCompleted(!hideCompleted)}
              className="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            >
              {hideCompleted ? (
                <>
                  <EyeIcon className="w-4 h-4" />
                  Show completed
                </>
              ) : (
                <>
                  <EyeSlashIcon className="w-4 h-4" />
                  Hide completed
                </>
              )}
            </button>
          </div>

          {/* Sections */}
          <div className="space-y-4">
        {/* The Essentials */}
        {(Object.keys(CATEGORY_CONFIG) as Array<keyof typeof CATEGORY_CONFIG>).map((category) => {
          const config = CATEGORY_CONFIG[category];
          const categoryTasks = getTasksByCategory(category);
          const visibleTasks = getVisibleTasks(category);
          const completedCount = getCompletedCount(category);
          const totalCount = categoryTasks.length;
          const isExpanded = expandedSections.has(category);

          return (
            <div key={category} className="bg-white rounded-xl border border-gray-200">
              {/* Section Header */}
              <div className="flex items-center">
                <button
                  onClick={() => {
                    toggleSection(category);
                    if (categoryTasks.length === 0) {
                      initializeDefaultTasks(category);
                    }
                  }}
                  className="flex-1 flex items-center justify-between p-4 hover:bg-gray-50 transition-colors rounded-tl-xl"
                >
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">{config.icon}</span>
                    <div className="text-left">
                      <h3 className="text-lg font-semibold text-gray-900">{config.title}</h3>
                      <p className="text-sm text-gray-500">
                        {totalCount > 0 && `${completedCount} of ${totalCount} complete`}
                      </p>
                    </div>
                  </div>
                  {isExpanded ? (
                    <ChevronUpIcon className="w-5 h-5 text-gray-400" />
                  ) : (
                    <ChevronDownIcon className="w-5 h-5 text-gray-400" />
                  )}
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleShowRecommendations(category);
                  }}
                  className="p-4 hover:bg-blue-50 transition-colors rounded-tr-xl group"
                  title="See recommended tasks"
                >
                  <InformationCircleIcon className="w-5 h-5 text-gray-400 group-hover:text-blue-600" />
                </button>
              </div>

              {/* Section Content */}
              {isExpanded && (
                <div className="border-t border-gray-200 p-4">
                  <div className="space-y-2">
                    {visibleTasks.map((task) => {
                      const isHospitalBagsTask = task.title.toLowerCase().includes('pack hospital bags');

                      return (
                        <div key={task.id}>
                          <div className="flex items-start gap-3 p-2 hover:bg-gray-50 rounded-lg group">
                            <input
                              type="checkbox"
                              checked={task.is_complete}
                              onChange={() => handleToggleTask(task.id)}
                              className="w-5 h-5 text-sage border-gray-300 rounded focus:ring-sage cursor-pointer mt-0.5"
                            />
                            <div className="flex-1">
                              <p className={`${task.is_complete ? 'line-through text-gray-400' : 'text-gray-900'}`}>
                                {task.title}
                              </p>
                              {task.description && (
                                <p className="text-xs text-gray-500 mt-1">{task.description}</p>
                              )}
                            </div>
                            <button
                              onClick={() => handleDeleteTask(task.id)}
                              className="opacity-0 group-hover:opacity-100 text-xs text-red-600 hover:text-red-700 transition-opacity"
                            >
                              Delete
                            </button>
                          </div>

                          {/* Special auto-generate button for hospital bags */}
                          {isHospitalBagsTask && !task.is_complete && (
                            <div className="ml-8 mt-2 mb-2">
                              {generatedPackListIds.length > 0 ? (
                                <div className="p-3 bg-green-50 border border-green-200 rounded-lg">
                                  <p className="text-sm text-green-800 mb-2">
                                    ‚úì Created {generatedPackListIds.length} hospital bag pack lists!
                                  </p>
                                  <Link
                                    href="/pack-lists"
                                    className="text-sm text-sage hover:underline font-medium"
                                  >
                                    View Pack Lists ‚Üí
                                  </Link>
                                </div>
                              ) : (
                                <button
                                  onClick={handleGenerateHospitalBags}
                                  disabled={generatingHospitalBags}
                                  className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-sage to-sage/80 text-white rounded-lg hover:opacity-90 transition-all text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                  <RocketLaunchIcon className="w-4 h-4" />
                                  {generatingHospitalBags ? 'Generating...' : `Auto-generate ${hasOlderChildren ? '5' : '3'} Pack Lists`}
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}

                    {hideCompleted && totalCount - visibleTasks.length > 0 && (
                      <p className="text-xs text-gray-500 italic py-2">
                        {totalCount - visibleTasks.length} item{totalCount - visibleTasks.length > 1 ? 's' : ''} hidden
                      </p>
                    )}
                  </div>

                  {/* Add New Task */}
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newTaskInputs[category] || ''}
                        onChange={(e) => setNewTaskInputs({ ...newTaskInputs, [category]: e.target.value })}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') handleAddTask(category);
                        }}
                        placeholder="Add a new task..."
                        className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage focus:border-transparent"
                      />
                      <button
                        onClick={() => handleAddTask(category)}
                        className="px-4 py-2 bg-sage text-white rounded-lg hover:opacity-90 text-sm font-medium flex items-center gap-2"
                      >
                        <PlusIcon className="w-4 h-4" />
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

          {/* Banner Reminder */}
          <div className="mt-8 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <p className="text-sm text-amber-900">
              <strong>Coming soon:</strong> We'll automatically organize these tasks by trimester based on your due date. For now, all features are visible to explore.
            </p>
          </div>
        </>
      )}

      {/* Recommendations Modal */}
      {showRecommendationsModal && recommendationsCategory && babyPrepList && (
        <RecommendedTasksModal
          category={recommendationsCategory}
          categoryTitle={CATEGORY_CONFIG[recommendationsCategory as keyof typeof CATEGORY_CONFIG]?.title || ''}
          recommendedTasks={getRecommendedTasksForFamily(recommendationsCategory, hasOlderChildren)}
          onClose={() => {
            setShowRecommendationsModal(false);
            setRecommendationsCategory(null);
          }}
          onAddTasks={handleAddRecommendedTasks}
        />
      )}
    </>
  );
}
